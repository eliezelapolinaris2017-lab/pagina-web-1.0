<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NeoCatálogo — Galería editable</title>
<meta name="theme-color" content="#0b0f14">
<style>
/* =========================
   NEO THEME (vidrio + neón)
   ========================= */
:root{
  --bg:#0b0f14;
  --fg:#eaf2ff;
  --muted:#9db0c9;
  --primary:#5df0c1;     /* verde neón */
  --accent:#7aa5ff;      /* azul neón */
  --danger:#ff6b6b;
  --outline:rgba(255,255,255,.08);
  --glass:rgba(255,255,255,.06);
  --radius:18px;
  --shadow:0 20px 60px rgba(0,0,0,.45);
  --font: ui-sans-serif, system-ui, -apple-system, "SF Pro", Inter, Segoe UI, Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:var(--font); color:var(--fg);
  background:
    radial-gradient(1300px 800px at -15% -10%, #11253b 0%, transparent 55%),
    radial-gradient(1200px 800px at 110% -10%, #1a1f38 0%, transparent 60%),
    radial-gradient(1400px 1000px at 50% 120%, #0f1e28 0%, transparent 50%),
    var(--bg);
}
a{color:inherit; text-decoration:none}
img{max-width:100%; display:block}
button{
  cursor:pointer; border:0; border-radius:12px; padding:.75rem 1rem;
  color:white; background:linear-gradient(135deg,var(--accent),var(--primary));
  box-shadow:0 6px 20px rgba(90,150,255,.25); transition:transform .15s ease, filter .15s ease, opacity .15s ease;
}
button:hover{transform:translateY(-1px)}
.btn-ghost{background:transparent; border:1px solid var(--outline); color:var(--fg); box-shadow:none}
.btn-danger{background:linear-gradient(135deg,#ff6b6b,#b92f2f)}
.btn-flat{background:#1a2430}
.input, select, textarea{
  width:100%; padding:.78rem .9rem; background:rgba(255,255,255,.05);
  border:1px solid var(--outline); color:var(--fg); border-radius:12px; outline:none;
  transition:border-color .15s ease, box-shadow .15s ease;
  backdrop-filter: blur(8px);
}
.input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(122,165,255,.25)}
label{display:block; font-size:.86rem; color:var(--muted); margin:.2rem 0 .35rem}
.container{max-width:1180px; margin:0 auto; padding:24px 18px 80px}
.header{
  position:sticky; top:0; z-index:50; backdrop-filter: blur(10px);
  background: linear-gradient(180deg, rgba(8,12,18,.85), rgba(8,12,18,.55));
  border-bottom:1px solid var(--outline);
}
.header-inner{
  display:flex; gap:12px; align-items:center; padding:10px 16px;
}
.brand{display:flex; align-items:center; gap:.8rem}
.brand .logo{width:36px; height:36px; border-radius:10px; object-fit:cover; border:1px solid var(--outline)}
.brand .title{font-weight:800; letter-spacing:.2px}
.nav{margin-left:auto; display:flex; gap:.4rem; flex-wrap:wrap}
.tab{border:1px solid var(--outline); background:var(--glass); padding:.5rem .8rem; border-radius:999px; font-size:.9rem}
.tab.active{border-color:transparent; background:linear-gradient(135deg, rgba(122,165,255,.25), rgba(93,240,193,.22))}
.screen{display:none}
.screen.active{display:block; animation:fade .18s ease}
@keyframes fade{from{opacity:.65; transform:translateY(2px)} to{opacity:1; transform:none}}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border:1px solid var(--outline); border-radius:var(--radius); box-shadow:var(--shadow); padding:1rem;
}
.hr{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent); margin:.9rem 0}
.footer{
  border-top:1px solid var(--outline); color:#b6c6db; text-align:center; padding:18px; background:rgba(0,0,0,.25)
}
.row{display:grid; gap:1rem}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:980px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
.grid{
  display:grid; gap:1rem;
  grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
}
.item{
  display:flex; flex-direction:column; gap:.6rem; overflow:hidden;
}
.item img{width:100%; height:180px; object-fit:cover; border-radius:12px; border:1px solid var(--outline)}
.price{padding:.2rem .55rem; border-radius:10px; border:1px solid var(--outline); background:rgba(122,165,255,.08); font-size:.85rem}
.toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
.small{font-size:.85rem; color:#c4d1e6}
.spacer{flex:1}
.badge{padding:.2rem .55rem; border-radius:999px; border:1px solid var(--outline); font-size:.78rem; background:rgba(255,255,255,.06)}
.hidden{display:none !important}
.divider{height:2px; background:linear-gradient(90deg,transparent,rgba(122,165,255,.5),transparent); margin:1.2rem 0}
  </style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <div class="brand">
      <img id="brandLogo" class="logo" alt="logo">
      <div>
        <div class="title" id="brandName">NeoCatálogo</div>
        <div class="small" id="brandSub">Galería editable</div>
      </div>
    </div>
    <nav class="nav">
      <a class="tab active" data-goto="screen-home">Inicio</a>
      <a class="tab" data-goto="screen-tab2">Pestaña 2</a>
      <a class="tab" data-goto="screen-tab3">Pestaña 3</a>
      <a class="tab" data-goto="screen-config">Configuración</a>
    </nav>
    <div class="toolbar">
      <button id="btnLogin" class="btn-ghost">Login</button>
      <button id="btnLogout" class="btn-ghost hidden">Salir</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- HOME -->
  <section id="screen-home" class="screen active">
    <div class="card">
      <div class="toolbar">
        <h2 style="margin:0">Página principal</h2>
        <span class="spacer"></span>
        <button id="btnAddItemHome" class="btn-ghost hidden">Añadir ítem</button>
        <button id="btnExportPDFHome" class="btn-ghost">Exportar PDF</button>
        <button id="btnShareWAHome" class="btn-ghost">Compartir por WhatsApp</button>
      </div>
      <div id="customHtmlHome" class="small"></div>
      <div class="divider"></div>
      <div id="gridHome" class="grid"></div>
    </div>
  </section>

  <!-- TAB 2 -->
  <section id="screen-tab2" class="screen">
    <div class="card">
      <div class="toolbar">
        <h2 style="margin:0">Pestaña 2</h2>
        <span class="spacer"></span>
        <button id="btnAddItemTab2" class="btn-ghost hidden">Añadir ítem</button>
        <button id="btnExportPDFTab2" class="btn-ghost">Exportar PDF</button>
        <button id="btnShareWATab2" class="btn-ghost">Compartir por WhatsApp</button>
      </div>
      <div id="customHtmlTab2" class="small"></div>
      <div class="divider"></div>
      <div id="gridTab2" class="grid"></div>
    </div>
  </section>

  <!-- TAB 3 -->
  <section id="screen-tab3" class="screen">
    <div class="card">
      <div class="toolbar">
        <h2 style="margin:0">Pestaña 3</h2>
        <span class="spacer"></span>
        <button id="btnAddItemTab3" class="btn-ghost hidden">Añadir ítem</button>
        <button id="btnExportPDFTab3" class="btn-ghost">Exportar PDF</button>
        <button id="btnShareWATab3" class="btn-ghost">Compartir por WhatsApp</button>
      </div>
      <div id="customHtmlTab3" class="small"></div>
      <div class="divider"></div>
      <div id="gridTab3" class="grid"></div>
    </div>
  </section>
    <!-- CONFIGURACIÓN -->
  <section id="screen-config" class="screen">
    <div class="card">
      <div class="toolbar">
        <h2 style="margin:0">Configuración</h2>
        <span class="spacer"></span>
        <button id="btnBackup" class="btn-ghost">Backup JSON</button>
        <label class="small">Restaurar</label>
        <input id="restoreFile" type="file" accept="application/json" class="input" style="width:auto">
      </div>
      <div class="hr"></div>

      <!-- Branding -->
      <div class="row cols-3">
        <div>
          <label>Nombre</label>
          <input id="cfg_name" class="input" placeholder="NeoCatálogo">
        </div>
        <div>
          <label>Subtítulo</label>
          <input id="cfg_sub" class="input" placeholder="Galería editable">
        </div>
        <div>
          <label>Logo</label>
          <input id="cfg_logo" type="file" accept="image/*" class="input">
        </div>
      </div>
      <div class="row cols-3" style="margin-top:.6rem">
        <div>
          <label>Color primario</label>
          <input id="cfg_primary" type="color" class="input" value="#5df0c1">
        </div>
        <div>
          <label>Color acento</label>
          <input id="cfg_accent" type="color" class="input" value="#7aa5ff">
        </div>
        <div style="display:flex;align-items:end">
          <button id="btnApplyBrand" class="btn-flat">Aplicar branding</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Redes / WhatsApp / YouTube -->
      <div class="row cols-3">
        <div>
          <label>Facebook URL</label>
          <input id="cfg_fb" class="input" placeholder="https://facebook.com/mi-pagina">
        </div>
        <div>
          <label>Instagram URL</label>
          <input id="cfg_ig" class="input" placeholder="https://instagram.com/mi-cuenta">
        </div>
        <div>
          <label>WhatsApp (teléfono)</label>
          <input id="cfg_wa" class="input" placeholder="+1 787 000 0000">
        </div>
      </div>
      <div class="row cols-3" style="margin-top:.6rem">
        <div>
          <label>Texto base WhatsApp</label>
          <input id="cfg_wa_text" class="input" placeholder="¡Hola! Me interesa este producto:">
        </div>
        <div>
          <label>Canal de YouTube (opcional)</label>
          <input id="cfg_yt" class="input" placeholder="https://youtube.com/@mi-canal">
        </div>
        <div style="display:flex;align-items:end">
          <button id="btnApplyLinks" class="btn-flat">Aplicar enlaces</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- HTML personalizado por pestaña -->
      <div class="row cols-3">
        <div>
          <label>Inicio — HTML</label>
          <textarea id="cfg_html_home" rows="6" class="input" placeholder="<div>Banner</div>"></textarea>
          <button id="btnApplyHtmlHome" class="btn-flat" style="margin-top:.6rem">Aplicar en Inicio</button>
        </div>
        <div>
          <label>Pestaña 2 — HTML</label>
          <textarea id="cfg_html_tab2" rows="6" class="input"></textarea>
          <button id="btnApplyHtmlTab2" class="btn-flat" style="margin-top:.6rem">Aplicar en Pestaña 2</button>
        </div>
        <div>
          <label>Pestaña 3 — HTML</label>
          <textarea id="cfg_html_tab3" rows="6" class="input"></textarea>
          <button id="btnApplyHtmlTab3" class="btn-flat" style="margin-top:.6rem">Aplicar en Pestaña 3</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Google Analytics -->
      <div class="row cols-3">
        <div>
          <label>ID de medición GA4</label>
          <input id="cfg_ga" class="input" placeholder="G-XXXXXXXX">
        </div>
        <div class="small" style="align-self:end">Al aplicar se inserta el script de GA4.</div>
        <div style="display:flex;align-items:end">
          <button id="btnApplyGA" class="btn-flat">Aplicar GA</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MODAL DE ÍTEM -->
  <div id="modal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:60">
    <div class="card" style="width:min(760px,92vw)">
      <div class="toolbar">
        <h3 style="margin:0" id="modalTitle">Nuevo ítem</h3>
        <span class="spacer"></span>
        <button id="btnCloseModal" class="btn-ghost">Cerrar</button>
      </div>
      <div class="hr"></div>
      <div class="row cols-2">
        <div>
          <label>Imagen (subir)</label>
          <input id="it_image" type="file" accept="image/*" class="input">
        </div>
        <div>
          <label>o URL de imagen</label>
          <input id="it_imgurl" class="input" placeholder="https://...">
        </div>
      </div>
      <div class="row cols-3" style="margin-top:.6rem">
        <div>
          <label>Título</label>
          <input id="it_title" class="input" placeholder="Nombre del producto">
        </div>
        <div>
          <label>Precio</label>
          <input id="it_price" type="number" step=".01" class="input" placeholder="25.00">
        </div>
        <div>
          <label>Link YouTube</label>
          <input id="it_yt" class="input" placeholder="https://youtu.be/...">
        </div>
      </div>
      <div class="row cols-2" style="margin-top:.6rem">
        <div>
          <label>Descripción</label>
          <textarea id="it_desc" rows="4" class="input"></textarea>
        </div>
        <div>
          <label>Enlace externo (FB / IG / web)</label>
          <input id="it_link" class="input" placeholder="https://...">
          <label style="margin-top:.6rem">WhatsApp (opcional)</label>
          <input id="it_wa" class="input" placeholder="+1 787 000 0000">
        </div>
      </div>
      <div class="toolbar" style="margin-top:.8rem">
        <button id="btnSaveItem" class="btn-flat">Guardar</button>
        <button id="btnDeleteItem" class="btn-danger hidden">Eliminar</button>
      </div>
    </div>
  </div>
</main>

<footer class="footer">
  © <span id="year"></span> <span id="footName">NeoCatálogo</span> — Todos los derechos reservados.
</footer>
<script>
/* =========================
   STORAGE / UTIL
========================= */
const KEY={CFG:'neo_cfg', ITEMS:'neo_items', SESSION:'neo_session'};
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s), byId=id=>document.getElementById(id);
const load=(k,d)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uuid=()=>crypto.randomUUID?crypto.randomUUID():(Date.now().toString(36)+Math.random().toString(36).slice(2));
const fmt=n=>(Number(n||0)).toLocaleString('es-PR',{style:'currency',currency:'USD'});
function fileToDataURL(f){return new Promise(r=>{const rd=new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(f);});}

/* =========================
   DEFAULTS
========================= */
function ensureDefaults(){
  if(!load(KEY.CFG)){
    save(KEY.CFG,{name:'NeoCatálogo',sub:'Galería editable',logo:null,primary:'#5df0c1',accent:'#7aa5ff',
      fb:'',ig:'',yt:'',waPhone:'',waText:'¡Hola! Me interesa este producto:',
      htmlHome:'',htmlTab2:'',htmlTab3:'',ga:''});
  }
  if(!load(KEY.ITEMS)){ save(KEY.ITEMS,{home:[],tab2:[],tab3:[]}); }
}

/* =========================
   THEME / BRAND
========================= */
function applyBrand(){
  const c=load(KEY.CFG,{});
  byId('brandName').textContent=c.name||'NeoCatálogo';
  byId('brandSub').textContent=c.sub||'';
  byId('footName').textContent=c.name||'NeoCatálogo';
  document.documentElement.style.setProperty('--primary',c.primary||'#5df0c1');
  document.documentElement.style.setProperty('--accent', c.accent ||'#7aa5ff');
  if(c.logo){ byId('brandLogo').src=c.logo; } else { byId('brandLogo').removeAttribute('src'); }
  byId('year').textContent=new Date().getFullYear();
}

/* =========================
   LOGIN (solo admin)
========================= */
function isAuthed(){ return !!load(KEY.SESSION,null); }
function openLogin(){
  const w=window.open('','_blank','width=360,height=360');
  w.document.write(`<!doctype html><meta charset="utf-8"><title>Login</title>
  <style>body{font-family:system-ui;padding:18px;background:#0b0f14;color:#eaf2ff}
  .i{width:100%;padding:.6rem .7rem;border:1px solid #445;border-radius:10px;background:#121a26;color:#fff;margin:.35rem 0}
  button{padding:.6rem .9rem;border:0;border-radius:10px;background:#4a8cff;color:#fff}</style>
  <h3>Entrar como admin</h3>
  <input id="u" class="i" placeholder="admin">
  <input id="p" class="i" type="password" placeholder="admin123">
  <button id="b">Entrar</button>
  <script>
    document.getElementById('b').onclick=()=>{
      const u=document.getElementById('u').value.trim();
      const p=document.getElementById('p').value.trim();
      if(u==='admin' && p==='admin123'){ opener.postMessage({neo:'login-ok'},'*'); window.close(); }
      else alert('Credenciales: admin / admin123');
    };
  <\/script>`);
  w.document.close();
}
function handleLoginMsg(e){
  if(e?.data?.neo==='login-ok'){ save(KEY.SESSION,{user:'admin'}); toggleAuthUI(); }
}
function logout(){ localStorage.removeItem(KEY.SESSION); toggleAuthUI(); }
function toggleAuthUI(){
  const on=isAuthed();
  byId('btnLogin').classList.toggle('hidden',on);
  byId('btnLogout').classList.toggle('hidden',!on);
  ['btnAddItemHome','btnAddItemTab2','btnAddItemTab3'].forEach(id=> byId(id).classList.toggle('hidden',!on));
}

/* =========================
   NAV
========================= */
function show(id){
  $$('.screen').forEach(s=>s.classList.remove('active'));
  byId(id).classList.add('active');
  $$('.tab').forEach(t=>t.classList.remove('active'));
  $$(`[data-goto="${id}"]`).forEach(t=>t.classList.add('active'));
}

/* =========================
   RENDER GALERÍAS
========================= */
function waButton(it){
  const cfg=load(KEY.CFG,{});
  const phone=(it.wa||cfg.waPhone||'').replace(/\D/g,'');
  if(!phone) return '';
  const txt=(cfg.waText||'Hola')+' '+(it.title||'');
  return `<a class="btn-ghost" target="_blank" href="https://wa.me/${phone}?text=${encodeURIComponent(txt)}">WhatsApp</a>`;
}
function cardTpl(it){
  const links = [it.yt?`<a class="small" target="_blank" href="${it.yt}">YouTube</a>`:'', it.link?`<a class="small" target="_blank" href="${it.link}">Enlace</a>`:'']
                 .filter(Boolean).join(' · ');
  const admin = isAuthed()? `<div class="toolbar"><button class="btn-ghost" onclick="openModal('${it.id}','${it.tab}')">Editar</button></div>` : '';
  return `<div class="item card">
    ${it.img? `<img src="${it.img}" alt="">` : ''}
    <div style="display:flex; gap:.5rem; align-items:center">
      <b>${it.title||'(sin título)'}</b>
      <span class="spacer"></span>
      ${it.price? `<span class="price">${fmt(it.price)}</span>`:''}
    </div>
    ${it.desc? `<div class="small">${it.desc}</div>`:''}
    <div class="toolbar">
      ${links}
      <span class="spacer"></span>
      ${waButton(it)}
    </div>
    ${admin}
  </div>`;
}
function renderTab(tab){
  const data=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const gridId = tab==='home'?'gridHome':(tab==='tab2'?'gridTab2':'gridTab3');
  byId(gridId).innerHTML = data.map(cardTpl).join('') || `<div class="small">No hay ítems.</div>`;
  const c=load(KEY.CFG,{});
  if(tab==='home') byId('customHtmlHome').innerHTML=c.htmlHome||'';
  if(tab==='tab2')  byId('customHtmlTab2').innerHTML=c.htmlTab2||'';
  if(tab==='tab3')  byId('customHtmlTab3').innerHTML=c.htmlTab3||'';
}
function renderAll(){ renderTab('home'); renderTab('tab2'); renderTab('tab3'); }

/* =========================
   MODAL ÍTEM
========================= */
let CURRENT_TAB='home', EDITING_ID=null;
function openModal(id=null,tab=CURRENT_TAB){
  CURRENT_TAB=tab; EDITING_ID=id;
  const list=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const it=id? list.find(x=>x.id===id) : {id:uuid(), tab};
  byId('modalTitle').textContent = id? 'Editar ítem' : 'Nuevo ítem';
  byId('it_title').value=it.title||''; byId('it_price').value=it.price||'';
  byId('it_desc').value=it.desc||''; byId('it_imgurl').value=it.img?.startsWith('http')?it.img:'';
  byId('it_yt').value=it.yt||''; byId('it_link').value=it.link||''; byId('it_wa').value=it.wa||'';
  byId('it_image').value='';
  byId('btnDeleteItem').classList.toggle('hidden',!id);
  byId('modal').classList.remove('hidden');
}
function closeModal(){ byId('modal').classList.add('hidden'); EDITING_ID=null; }
async function saveItem(){
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]});
  const list=items[CURRENT_TAB];
  let img=byId('it_imgurl').value.trim();
  const f=byId('it_image').files?.[0]; if(f) img=await fileToDataURL(f);
  const data={ id:EDITING_ID||uuid(), tab:CURRENT_TAB,
    title:byId('it_title').value.trim(), price:+byId('it_price').value||0,
    desc:byId('it_desc').value.trim(), img:img||null,
    yt:byId('it_yt').value.trim(), link:byId('it_link').value.trim(),
    wa:byId('it_wa').value.trim()
  };
  const ex=list.find(x=>x.id===data.id);
  if(ex){ list.splice(list.indexOf(ex),1,data);} else { list.push(data); }
  save(KEY.ITEMS,items); renderTab(CURRENT_TAB); closeModal();
}
function deleteItem(){
  if(!EDITING_ID) return;
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]});
  items[CURRENT_TAB]=items[CURRENT_TAB].filter(x=>x.id!==EDITING_ID);
  save(KEY.ITEMS,items); renderTab(CURRENT_TAB); closeModal();
}

/* =========================
   CONFIG — aplicar
========================= */
async function applyBranding(){
  const c={...load(KEY.CFG,{})};
  c.name=byId('cfg_name').value.trim()||c.name;
  c.sub =byId('cfg_sub').value.trim() ||c.sub;
  c.primary=byId('cfg_primary').value||c.primary;
  c.accent =byId('cfg_accent').value ||c.accent;
  const f=byId('cfg_logo').files?.[0]; if(f) c.logo=await fileToDataURL(f);
  save(KEY.CFG,c); applyBrand(); alert('Branding aplicado');
}
function applyLinks(){
  const c={...load(KEY.CFG,{})};
  c.fb=byId('cfg_fb').value.trim(); c.ig=byId('cfg_ig').value.trim();
  c.waPhone=byId('cfg_wa').value.trim(); c.waText=byId('cfg_wa_text').value.trim();
  c.yt=byId('cfg_yt').value.trim();
  save(KEY.CFG,c); alert('Enlaces actualizados');
}
function applyHtml(where){
  const c={...load(KEY.CFG,{})};
  if(where==='home') c.htmlHome=byId('cfg_html_home').value;
  if(where==='tab2') c.htmlTab2 =byId('cfg_html_tab2').value;
  if(where==='tab3') c.htmlTab3 =byId('cfg_html_tab3').value;
  save(KEY.CFG,c); renderAll(); alert('HTML aplicado');
}
function injectGA(){
  const c=load(KEY.CFG,{}); if(!c.ga) return;
  if(byId('ga4tag')) return;
  const s=document.createElement('script'); s.id='ga4tag'; s.async=true;
  s.src=`https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(c.ga)}`;
  document.head.appendChild(s);
  const x=document.createElement('script');
  x.innerHTML=`window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);} gtag('js',new Date()); gtag('config','${c.ga}');`;
  document.head.appendChild(x);
}
function applyGA(){ const c={...load(KEY.CFG,{})}; c.ga=byId('cfg_ga').value.trim(); save(KEY.CFG,c); injectGA(); alert('GA aplicado'); }

/* =========================
   EXPORTAR PDF / WHATSAPP
========================= */
function exportPDF(tab){
  const cfg=load(KEY.CFG,{});
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const title=tab==='home'?'Página principal':(tab==='tab2'?'Pestaña 2':'Pestaña 3');
  const rows=items.map(i=>`<tr><td>${i.title||''}</td><td>${i.price?fmt(i.price):''}</td><td>${i.desc||''}</td></tr>`).join('');
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>${cfg.name} - ${title}</title>
  <style>body{font-family:${getComputedStyle(document.documentElement).getPropertyValue('--font')||'system-ui'};padding:20px}
  table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ccc;padding:8px;text-align:left}</style>
  </head><body><h2>${cfg.name||''}</h2><div>${cfg.sub||''}</div><hr><h3>${title}</h3>
  <table><thead><tr><th>Título</th><th>Precio</th><th>Descripción</th></tr></thead><tbody>${rows}</tbody></table>
  <script>window.addEventListener('load',()=>window.print());<\/script></body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus();
}
function shareWA(tab){
  const cfg=load(KEY.CFG,{});
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const lines=items.slice(0,20).map(i=>`• ${i.title||''}${i.price?' — '+fmt(i.price):''}`).join('\n');
  const phone=(cfg.waPhone||'').replace(/\D/g,'');
  const msg=`${cfg.name||'Catálogo'}\n${lines}\n${cfg.fb||''}\n${cfg.ig||''}`;
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
}

/* =========================
   BACKUP / RESTAURAR
========================= */
function doBackup(){
  const payload={cfg:load(KEY.CFG,{}), items:load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  a.download=`neocatalog_backup_${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
}
function doRestore(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const j=JSON.parse(r.result);
      if(j.cfg) save(KEY.CFG,j.cfg);
      if(j.items) save(KEY.ITEMS,j.items);
      applyBrand(); renderAll(); injectGA();
      alert('Restaurado correctamente');
    }catch{alert('Archivo inválido');}
  };
  r.readAsText(file);
}

/* =========================
   BIND UI
========================= */
function bindUI(){
  // tabs
  $$('[data-goto]').forEach(a=> a.onclick=()=> show(a.dataset.goto));
  // login
  byId('btnLogin').onclick=openLogin;
  byId('btnLogout').onclick=logout;
  window.addEventListener('message',handleLoginMsg);
  // add item
  byId('btnAddItemHome').onclick=()=>{CURRENT_TAB='home';openModal(null,'home');};
  byId('btnAddItemTab2').onclick =()=>{CURRENT_TAB='tab2';openModal(null,'tab2');};
  byId('btnAddItemTab3').onclick =()=>{CURRENT_TAB='tab3';openModal(null,'tab3');};
  // export & share
  byId('btnExportPDFHome').onclick=()=>exportPDF('home');
  byId('btnExportPDFTab2').onclick=()=>exportPDF('tab2');
  byId('btnExportPDFTab3').onclick=()=>exportPDF('tab3');
  byId('btnShareWAHome').onclick=()=>shareWA('home');
  byId('btnShareWATab2').onclick=()=>shareWA('tab2');
  byId('btnShareWATab3').onclick=()=>shareWA('tab3');
  // modal
  byId('btnCloseModal').onclick=closeModal;
  byId('btnSaveItem').onclick=saveItem;
  byId('btnDeleteItem').onclick=deleteItem;
  // config apply
  byId('btnApplyBrand').onclick=applyBranding;
  byId('btnApplyLinks').onclick=applyLinks;
  byId('btnApplyHtmlHome').onclick=()=>applyHtml('home');
  byId('btnApplyHtmlTab2').onclick=()=>applyHtml('tab2');
  byId('btnApplyHtmlTab3').onclick=()=>applyHtml('tab3');
  byId('btnApplyGA').onclick=applyGA;
  // backup/restore
  byId('btnBackup').onclick=doBackup;
  byId('restoreFile').addEventListener('change',e=>e.target.files[0]&&doRestore(e.target.files[0]));
}

/* =========================
   BOOT
========================= */
function boot(){
  ensureDefaults();
  applyBrand();
  renderAll();
  injectGA();
  toggleAuthUI();
  bindUI();
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
