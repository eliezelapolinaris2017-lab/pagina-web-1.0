<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Catálogo Editable — Admin</title>
<meta name="theme-color" content="#0f0f12">

<style>
:root{
  --bg:#0f0f12; --fg:#fff; --muted:#a7a7b1; --primary:#6ee7b7; --accent:#93c5fd;
  --danger:#ef4444; --warn:#f59e0b; --card:#171821; --card2:#1e202b;
  --outline:#2a2d40; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{margin:0; color:var(--fg); background:#0f0f12; font-family:var(--font)}
a{color:inherit; text-decoration:none}
.container{max-width:1140px; margin:0 auto; padding:16px}
.row{display:grid; gap:12px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:repeat(3,1fr)}
.row.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:980px){.row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid var(--outline); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
.input, select, textarea{width:100%; padding:.75rem .85rem; border:1px solid var(--outline); border-radius:12px; background:#11131a; color:#fff; outline:none}
.input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(147,197,253,.25)}
label{display:block; font-size:.88rem; color:var(--muted); margin:0 0 .35rem}
button{cursor:pointer; border:0; border-radius:12px; padding:.7rem .95rem; background:#24263a; color:#fff; box-shadow:var(--shadow)}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}
.btn-ghost{background:transparent; border:1px solid var(--outline)}
.btn-danger{background:linear-gradient(135deg,var(--danger),#b91c1c)}
.btn-warn{background:linear-gradient(135deg,var(--warn),#f59e0b)}
.toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
.spacer{flex:1}
.badge{display:inline-flex; gap:.35rem; padding:.25rem .55rem; border:1px solid var(--outline); background:#101323; border-radius:999px; font-size:.78rem; color:#c7d2fe}
.header{
  position:sticky; top:0; z-index:10; background:rgba(15,15,18,.9); backdrop-filter:blur(8px);
  border-bottom:1px solid var(--outline)
}
.header .inner{display:flex; align-items:center; gap:.8rem; padding:.8rem 16px; max-width:1140px; margin:0 auto}
.logo{width:40px; height:40px; border-radius:10px; object-fit:cover; border:1px solid var(--outline); background:#0e1020}
.brand{font-weight:800; letter-spacing:.2px}
.nav{margin-left:auto; display:flex; gap:.4rem; align-items:center}
.tabbar{display:flex; gap:.4rem; flex-wrap:wrap}
.tabbar button{padding:.5rem .8rem}
.screen{display:none}
.screen.active{display:block; animation:fade .15s ease}
@keyframes fade{from{opacity:.5; transform:translateY(2px)} to{opacity:1; transform:none}}
.grid-cards{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
@media (max-width:980px){.grid-cards{grid-template-columns:1fr}}
.item{display:flex; flex-direction:column; gap:.6rem}
.item img{width:100%; height:220px; object-fit:cover; border-radius:12px; border:1px solid var(--outline); background:#0b0e1a}
.price{font-weight:800}
.hr{height:1px; background:linear-gradient(90deg,transparent,#2b3150,transparent); margin:12px 0}
.footer{border-top:1px solid var(--outline); color:#a9b2dc; text-align:center; padding:16px}
.small{font-size:.85rem; color:#a9b2dc}
.center{text-align:center}
.hidden{display:none !important}
</style>
</head>
<body>
<header class="header">
  <div class="inner">
    <img id="brandLogo" class="logo" alt="logo">
    <div>
      <div class="brand" id="brandName">Mi Catálogo</div>
      <div class="small" id="brandSub">Galería editable</div>
    </div>
    <div class="nav">
      <div class="tabbar">
        <button class="btn-ghost" data-goto="screen-home">Inicio</button>
        <button class="btn-ghost" data-goto="screen-tab2">Pestaña 2</button>
        <button class="btn-ghost" data-goto="screen-tab3">Pestaña 3</button>
        <button class="btn-ghost" data-goto="screen-config">Configuración</button>
      </div>
      <button id="btnLogin" class="btn-primary">Admin</button>
      <button id="btnLogout" class="btn-danger hidden">Salir</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- LOGIN -->
  <section id="screen-login" class="screen">
    <div class="row cols-2">
      <div class="card">
        <h2>Iniciar sesión</h2>
        <div class="hr"></div>
        <label>Usuario</label><input id="loginUser" class="input" placeholder="admin">
        <label>Contraseña</label><input id="loginPass" type="password" class="input" placeholder="••••••••">
        <div class="toolbar" style="margin-top:.6rem">
          <button id="doLogin" class="btn-primary">Entrar</button>
          <span class="spacer"></span>
          <span class="small">Admin por defecto: <b>admin / admin123</b></span>
        </div>
      </div>
      <div class="card">
        <h3>¿Qué obtienes al iniciar sesión?</h3>
        <ul class="small">
          <li>Agregar/editar/eliminar ítems (foto, texto, precio, YouTube, WhatsApp).</li>
          <li>Configurar logo, colores, links sociales, ID de Analytics.</li>
          <li>Agregar código HTML personalizado.</li>
          <li>Crear y gestionar pestañas adicionales.</li>
          <li>Backup/Restaurar la base de datos (JSON).</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- HOME -->
  <section id="screen-home" class="screen active">
    <div class="toolbar">
      <h2 style="margin:0">Catálogo — Página principal</h2>
      <span class="spacer"></span>
      <button id="btnAddItemHome" class="btn-primary hidden">Añadir ítem</button>
      <button id="btnExportPDFHome" class="btn-ghost">Exportar PDF</button>
      <button id="btnShareWAHome" class="btn-ghost">Compartir por WhatsApp</button>
    </div>
    <div id="customHtmlHome"></div>
    <div class="hr"></div>
    <div id="gridHome" class="grid-cards"></div>
  </section>

  <!-- TAB 2 -->
  <section id="screen-tab2" class="screen">
    <div class="toolbar">
      <h2 style="margin:0">Pestaña 2</h2>
      <span class="spacer"></span>
      <button id="btnAddItemTab2" class="btn-primary hidden">Añadir ítem</button>
      <button id="btnExportPDFTab2" class="btn-ghost">Exportar PDF</button>
      <button id="btnShareWATab2" class="btn-ghost">Compartir por WhatsApp</button>
    </div>
    <div id="customHtmlTab2"></div>
    <div class="hr"></div>
    <div id="gridTab2" class="grid-cards"></div>
  </section>

  <!-- TAB 3 -->
  <section id="screen-tab3" class="screen">
    <div class="toolbar">
      <h2 style="margin:0">Pestaña 3</h2>
      <span class="spacer"></span>
      <button id="btnAddItemTab3" class="btn-primary hidden">Añadir ítem</button>
      <button id="btnExportPDFTab3" class="btn-ghost">Exportar PDF</button>
      <button id="btnShareWATab3" class="btn-ghost">Compartir por WhatsApp</button>
    </div>
    <div id="customHtmlTab3"></div>
    <div class="hr"></div>
    <div id="gridTab3" class="grid-cards"></div>
  </section>
    <!-- CONFIGURACIÓN -->
  <section id="screen-config" class="screen">
    <div class="toolbar">
      <h2 style="margin:0">Configuración</h2>
      <span class="spacer"></span>
      <button id="btnBackup" class="btn-ghost">Backup JSON</button>
      <label class="small">Restaurar</label>
      <input id="restoreFile" type="file" accept="application/json" class="input" style="width:auto">
    </div>

    <!-- Branding -->
    <div class="card">
      <h3 style="margin:0">Branding</h3>
      <div class="hr"></div>
      <div class="row cols-3">
        <div>
          <label>Nombre</label>
          <input id="cfg_name" class="input" placeholder="Mi Catálogo">
        </div>
        <div>
          <label>Subtítulo</label>
          <input id="cfg_sub" class="input" placeholder="Galería editable">
        </div>
        <div>
          <label>Logo</label>
          <input id="cfg_logo" class="input" type="file" accept="image/*">
        </div>
      </div>
      <div class="row cols-3" style="margin-top:.6rem">
        <div>
          <label>Primario</label>
          <input id="cfg_primary" type="color" class="input" value="#6ee7b7">
        </div>
        <div>
          <label>Acento</label>
          <input id="cfg_accent" type="color" class="input" value="#93c5fd">
        </div>
        <div style="display:flex;align-items:end">
          <button id="btnApplyBrand" class="btn-primary">Aplicar cambios</button>
        </div>
      </div>
    </div>

    <!-- Redes / WhatsApp / YouTube -->
    <div class="card" style="margin-top:1rem">
      <h3 style="margin:0">Enlaces y mensajería</h3>
      <div class="hr"></div>
      <div class="row cols-3">
        <div>
          <label>Facebook URL</label>
          <input id="cfg_fb" class="input" placeholder="https://facebook.com/mi-pagina">
        </div>
        <div>
          <label>Instagram URL</label>
          <input id="cfg_ig" class="input" placeholder="https://instagram.com/mi-cuenta">
        </div>
        <div>
          <label>WhatsApp (teléfono)</label>
          <input id="cfg_wa" class="input" placeholder="+1 787 000 0000">
        </div>
      </div>
      <div class="row cols-3" style="margin-top:.6rem">
        <div>
          <label>Texto base WhatsApp</label>
          <input id="cfg_wa_text" class="input" placeholder="¡Hola! Me interesa este producto:">
        </div>
        <div>
          <label>Canal de YouTube (opcional)</label>
          <input id="cfg_yt" class="input" placeholder="https://youtube.com/@mi-canal">
        </div>
        <div style="display:flex;align-items:end">
          <button id="btnApplyLinks" class="btn-primary">Aplicar cambios</button>
        </div>
      </div>
    </div>

    <!-- HTML Personalizado por pestaña -->
    <div class="card" style="margin-top:1rem">
      <h3 style="margin:0">HTML personalizado (encabezados, banners, etc.)</h3>
      <div class="hr"></div>
      <div class="row cols-3">
        <div>
          <label>Inicio — HTML</label>
          <textarea id="cfg_html_home" rows="6" class="input" placeholder="<div>Mi banner</div>"></textarea>
          <button id="btnApplyHtmlHome" class="btn-primary" style="margin-top:.6rem">Aplicar en Inicio</button>
        </div>
        <div>
          <label>Pestaña 2 — HTML</label>
          <textarea id="cfg_html_tab2" rows="6" class="input"></textarea>
          <button id="btnApplyHtmlTab2" class="btn-primary" style="margin-top:.6rem">Aplicar en Pestaña 2</button>
        </div>
        <div>
          <label>Pestaña 3 — HTML</label>
          <textarea id="cfg_html_tab3" rows="6" class="input"></textarea>
          <button id="btnApplyHtmlTab3" class="btn-primary" style="margin-top:.6rem">Aplicar en Pestaña 3</button>
        </div>
      </div>
    </div>

    <!-- Google Analytics -->
    <div class="card" style="margin-top:1rem">
      <h3 style="margin:0">Google Analytics</h3>
      <div class="hr"></div>
      <div class="row cols-3">
        <div>
          <label>ID de medición (G-XXXXXXX)</label>
          <input id="cfg_ga" class="input" placeholder="G-XXXXXXXX">
        </div>
        <div class="small" style="align-self:end">
          Si agregas un ID válido, se cargará automáticamente el script de GA4.
        </div>
        <div style="display:flex;align-items:end">
          <button id="btnApplyGA" class="btn-primary">Aplicar GA</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MODAL ÍTEM (reutilizable para todas las pestañas) -->
  <div id="modal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50">
    <div class="card" style="width:min(720px,92vw)">
      <div class="toolbar">
        <h3 style="margin:0" id="modalTitle">Nuevo ítem</h3>
        <span class="spacer"></span>
        <button id="btnCloseModal" class="btn-ghost">Cerrar</button>
      </div>
      <div class="hr"></div>
      <div class="row cols-2">
        <div>
          <label>Imagen (subir) — opcional</label>
          <input id="it_image" type="file" accept="image/*" class="input">
        </div>
        <div>
          <label>o URL de imagen (https://...)</label>
          <input id="it_imgurl" class="input" placeholder="https://...">
        </div>
      </div>
      <div class="row cols-3" style="margin-top:.6rem">
        <div>
          <label>Título</label>
          <input id="it_title" class="input" placeholder="Nombre del producto">
        </div>
        <div>
          <label>Precio</label>
          <input id="it_price" type="number" step=".01" class="input" placeholder="25.00">
        </div>
        <div>
          <label>Link YouTube (opcional)</label>
          <input id="it_yt" class="input" placeholder="https://youtu.be/...">
        </div>
      </div>
      <div class="row cols-2" style="margin-top:.6rem">
        <div>
          <label>Descripción / texto bajo la foto</label>
          <textarea id="it_desc" rows="4" class="input"></textarea>
        </div>
        <div>
          <label>Enlace externo (Facebook / Instagram / sitio)</label>
          <input id="it_link" class="input" placeholder="https://...">
          <label style="margin-top:.6rem">WhatsApp (dejar vacío para usar el de Config)</label>
          <input id="it_wa" class="input" placeholder="+1 787 000 0000">
        </div>
      </div>
      <div class="toolbar" style="margin-top:.8rem">
        <button id="btnSaveItem" class="btn-primary">Guardar</button>
        <button id="btnDeleteItem" class="btn-danger hidden">Eliminar</button>
      </div>
    </div>
  </div>

  <div class="hr"></div>
</main>

<footer class="footer">
  © <span id="year"></span> <span id="footName">Mi Catálogo</span> — Todos los derechos reservados.
</footer>
<script>
/* =========================
   STORAGE / ESTADO
========================= */
const KEY = {
  CFG: 'cat_cfg',
  ITEMS: 'cat_items',        // {home:[], tab2:[], tab3:[]}
  SESSION: 'cat_session'     // {user:'admin'}
};
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const byId = id => document.getElementById(id);
const load = (k,d)=> JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const save = (k,v)=> localStorage.setItem(k,JSON.stringify(v));
const uuid = () => crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2));
const fmt = n => (Number(n||0)).toLocaleString('es-PR',{style:'currency',currency:'USD'});

/* =========================
   DEFAULTS
========================= */
function ensureDefaults(){
  if(!load(KEY.CFG)){
    save(KEY.CFG, {
      name:'Mi Catálogo', sub:'Galería editable',
      primary:'#6ee7b7', accent:'#93c5fd',
      logo:null,
      fb:'', ig:'', yt:'', waPhone:'', waText:'¡Hola! Me interesa este producto:',
      htmlHome:'', htmlTab2:'', htmlTab3:'',
      ga:''
    });
  }
  if(!load(KEY.ITEMS)){
    save(KEY.ITEMS, {home:[], tab2:[], tab3:[]});
  }
}

/* =========================
   BRAND / THEME
========================= */
function applyBrand(){
  const c=load(KEY.CFG,{});
  byId('brandName').textContent = c.name||'Mi Catálogo';
  byId('brandSub').textContent  = c.sub || 'Galería editable';
  byId('footName').textContent  = c.name||'Mi Catálogo';
  document.documentElement.style.setProperty('--primary', c.primary||'#6ee7b7');
  document.documentElement.style.setProperty('--accent',  c.accent ||'#93c5fd');
  if(c.logo){ byId('brandLogo').src=c.logo; } else { byId('brandLogo').removeAttribute('src'); }
  byId('year').textContent = new Date().getFullYear();
}

/* =========================
   LOGIN (solo admin)
========================= */
function isAuthed(){ return !!load(KEY.SESSION,null); }
function toggleAuthUI(){
  const on=isAuthed();
  byId('btnLogin').classList.toggle('hidden', on);
  byId('btnLogout').classList.toggle('hidden', !on);
  // botones de añadir visibles solo logueado
  ['btnAddItemHome','btnAddItemTab2','btnAddItemTab3'].forEach(id=> byId(id).classList.toggle('hidden', !on));
}
function doLogin(){
  const u=byId('loginUser').value.trim();
  const p=byId('loginPass').value.trim();
  if(u==='admin' && p==='admin123'){
    save(KEY.SESSION,{user:'admin'});
    show('screen-home');
    toggleAuthUI();
  }else{
    alert('Usuario o contraseña incorrectos (admin / admin123)');
  }
}
function doLogout(){
  localStorage.removeItem(KEY.SESSION);
  toggleAuthUI();
  show('screen-home');
}

/* =========================
   NAV
========================= */
function show(id){
  $$('.screen').forEach(s=>s.classList.remove('active'));
  byId(id).classList.add('active');
}

/* =========================
   RENDER DE ÍTEMS
========================= */
function cardTpl(it){
  const img = it.img || '';
  const price = it.price ? `<div class="price">${fmt(it.price)}</div>` : '';
  const yt = it.yt ? `<a href="${it.yt}" target="_blank" class="small">YouTube</a>` : '';
  const link = it.link ? `<a href="${it.link}" target="_blank" class="small">Enlace</a>` : '';
  const waPh = (it.wa||load(KEY.CFG,{}).waPhone||'').replace(/\D/g,'');
  const waBtn = waPh ? `<a class="btn-ghost" target="_blank" href="https://wa.me/${waPh}?text=${encodeURIComponent((load(KEY.CFG,{}).waText||'Hola')+' '+(it.title||''))}">WhatsApp</a>` : '';
  const adminBtns = isAuthed()
    ? `<div class="toolbar"><button class="btn-ghost" onclick="openModal('${it.id}','${it.tab}')">Editar</button></div>`
    : '';
  return `
    <div class="item card">
      ${img? `<img src="${img}" alt="">` : ''}
      <div style="display:flex;gap:.5rem;align-items:center">
        <b>${it.title||'(sin título)'}</b>
        <span class="spacer"></span>
        ${price}
      </div>
      ${it.desc? `<div class="small">${it.desc}</div>`:''}
      <div class="toolbar">
        ${yt}${yt&&link?' · ':''}${link}
        <span class="spacer"></span>
        ${waBtn}
      </div>
      ${adminBtns}
    </div>`;
}
function renderTab(tab){
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const gridId = tab==='home' ? 'gridHome' : (tab==='tab2' ? 'gridTab2' : 'gridTab3');
  byId(gridId).innerHTML = items.map(cardTpl).join('') || `<div class="small">No hay ítems todavía.</div>`;
  // HTML personalizado
  if(tab==='home') byId('customHtmlHome').innerHTML = load(KEY.CFG,{}).htmlHome||'';
  if(tab==='tab2') byId('customHtmlTab2').innerHTML = load(KEY.CFG,{}).htmlTab2||'';
  if(tab==='tab3') byId('customHtmlTab3').innerHTML = load(KEY.CFG,{}).htmlTab3||'';
}
function renderAll(){ renderTab('home'); renderTab('tab2'); renderTab('tab3'); }

/* =========================
   MODAL ÍTEM
========================= */
let CURRENT_TAB = 'home';
let EDITING_ID = null;

function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

function openModal(id=null, tab=CURRENT_TAB){
  CURRENT_TAB = tab;
  EDITING_ID = id;
  const items = load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const it = id ? items.find(x=>x.id===id) : {id:uuid(), tab};
  byId('modalTitle').textContent = id? 'Editar ítem' : 'Nuevo ítem';
  byId('it_title').value = it.title||'';
  byId('it_price').value = it.price||'';
  byId('it_desc').value = it.desc||'';
  byId('it_imgurl').value = it.img?.startsWith('http') ? it.img : '';
  byId('it_yt').value = it.yt||'';
  byId('it_link').value = it.link||'';
  byId('it_wa').value = it.wa||'';
  byId('it_image').value = '';
  byId('btnDeleteItem').classList.toggle('hidden', !id);
  byId('modal').classList.remove('hidden');
}
function closeModal(){ byId('modal').classList.add('hidden'); EDITING_ID=null; }

async function saveItem(){
  const items = load(KEY.ITEMS,{home:[],tab2:[],tab3:[]});
  const list = items[CURRENT_TAB];
  let img = byId('it_imgurl').value.trim();
  const f = byId('it_image').files?.[0];
  if(f){ img = await fileToDataURL(f); }
  const data = {
    id: EDITING_ID || uuid(),
    tab: CURRENT_TAB,
    title: byId('it_title').value.trim(),
    price: +byId('it_price').value || 0,
    desc: byId('it_desc').value.trim(),
    img: img || null,
    yt: byId('it_yt').value.trim(),
    link: byId('it_link').value.trim(),
    wa: byId('it_wa').value.trim()
  };
  const exists = list.find(x=>x.id===data.id);
  if(exists) list.splice(list.indexOf(exists),1,data); else list.push(data);
  save(KEY.ITEMS, items);
  closeModal();
  renderTab(CURRENT_TAB);
}

function deleteItem(){
  if(!EDITING_ID) return;
  const items = load(KEY.ITEMS,{home:[],tab2:[],tab3:[]});
  const list = items[CURRENT_TAB].filter(x=>x.id!==EDITING_ID);
  items[CURRENT_TAB] = list;
  save(KEY.ITEMS, items);
  closeModal(); renderTab(CURRENT_TAB);
}

/* =========================
   CONFIGURACIÓN — APLICAR
========================= */
async function logoFileToBase64(file){
  if(!file) return null; return await fileToDataURL(file);
}
async function applyBranding(){
  const c={...load(KEY.CFG,{})};
  c.name = byId('cfg_name').value.trim()||c.name;
  c.sub  = byId('cfg_sub').value.trim() || c.sub;
  c.primary = byId('cfg_primary').value || c.primary;
  c.accent  = byId('cfg_accent').value  || c.accent;
  const f = byId('cfg_logo').files?.[0];
  if(f){ c.logo = await logoFileToBase64(f); }
  save(KEY.CFG,c); applyBrand();
  alert('Branding aplicado.');
}
function applyLinks(){
  const c={...load(KEY.CFG,{})};
  c.fb = byId('cfg_fb').value.trim();
  c.ig = byId('cfg_ig').value.trim();
  c.waPhone = byId('cfg_wa').value.trim();
  c.waText  = byId('cfg_wa_text').value.trim();
  c.yt = byId('cfg_yt').value.trim();
  save(KEY.CFG,c);
  alert('Enlaces actualizados.');
}
function applyHtml(tab){
  const c={...load(KEY.CFG,{})};
  if(tab==='home') c.htmlHome = byId('cfg_html_home').value;
  if(tab==='tab2') c.htmlTab2  = byId('cfg_html_tab2').value;
  if(tab==='tab3') c.htmlTab3  = byId('cfg_html_tab3').value;
  save(KEY.CFG,c); renderAll();
  alert('HTML aplicado.');
}
function applyGA(){
  const c={...load(KEY.CFG,{})};
  c.ga = byId('cfg_ga').value.trim();
  save(KEY.CFG,c);
  injectGA();
  alert('Google Analytics aplicado.');
}

/* =========================
   GOOGLE ANALYTICS (GA4)
========================= */
function injectGA(){
  const c=load(KEY.CFG,{});
  if(!c.ga) return;
  if(document.getElementById('ga4tag')) return; // ya cargado
  const s=document.createElement('script'); s.id='ga4tag'; s.async=true;
  s.src=`https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(c.ga)}`;
  document.head.appendChild(s);
  const snip=document.createElement('script');
  snip.innerHTML = `window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '${c.ga}');`;
  document.head.appendChild(snip);
}

/* =========================
   EXPORTAR PDF (sin romper el HTML)
========================= */
function exportPDFFor(tab){
  const c=load(KEY.CFG,{});
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const title = tab==='home'?'Página principal':(tab==='tab2'?'Pestaña 2':'Pestaña 3');

  // Armamos HTML simple imprimible
  const rows = items.map(i=>`
    <tr>
      <td>${i.title||''}</td>
      <td>${i.price? fmt(i.price):''}</td>
      <td>${i.desc||''}</td>
    </tr>`).join('');

  const html =
`<!doctype html><html><head><meta charset="utf-8"><title>${c.name} - ${title}</title>
<style>
  body{font-family: ${getComputedStyle(document.documentElement).getPropertyValue('--font')}; padding:20px}
  h1,h2,h3{margin:0 0 8px}
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th,td{border:1px solid #ccc; padding:8px; text-align:left; vertical-align:top}
</style>
</head><body>
  <h2>${c.name||'Catálogo'}</h2>
  <div>${c.sub||''}</div>
  <hr>
  <h3>${title}</h3>
  <table>
    <thead><tr><th>Título</th><th>Precio</th><th>Descripción</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
  <script>window.addEventListener('load',()=>{window.print();});<\/script>
</body></html>`;

  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus();
}

/* =========================
   COMPARTIR WHATSAPP (link)
========================= */
function shareWALink(tab){
  const c=load(KEY.CFG,{});
  const items=load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})[tab];
  const lines = items.slice(0,20).map(i=>`• ${i.title||''}${i.price? ' — '+fmt(i.price):''}`).join('\n');
  const msg = `${c.name||'Mi Catálogo'}\n${lines}\n${c.fb||''}\n${c.ig||''}`;
  const phone = (c.waPhone||'').replace(/\D/g,'');
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
  window.open(url,'_blank');
}

/* =========================
   BACKUP / RESTORE
========================= */
function doBackup(){
  const dump = {
    cfg: load(KEY.CFG,{}),
    items: load(KEY.ITEMS,{home:[],tab2:[],tab3:[]})
  };
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(dump,null,2)],{type:'application/json'}));
  a.download=`catalog_backup_${Date.now()}.json`;
  a.click(); URL.revokeObjectURL(a.href);
}
function doRestore(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const j=JSON.parse(r.result);
      if(j.cfg) save(KEY.CFG,j.cfg);
      if(j.items) save(KEY.ITEMS,j.items);
      applyBrand(); renderAll(); injectGA();
      alert('Restaurado correctamente.');
    }catch{ alert('Archivo inválido.'); }
  };
  r.readAsText(file);
}

/* =========================
   BIND UI
========================= */
function bindUI(){
  // Tabs
  $$('[data-goto]').forEach(b=> b.onclick=()=> show(b.dataset.goto));

  // Login
  byId('btnLogin').onclick = ()=> show('screen-login');
  byId('btnLogout').onclick= doLogout;
  byId('doLogin').onclick = doLogin;
  ['loginUser','loginPass'].forEach(id=>{
    const el=byId(id);
    el && el.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
  });

  // Add item
  byId('btnAddItemHome').onclick = ()=>{ CURRENT_TAB='home'; openModal(null,'home'); };
  byId('btnAddItemTab2').onclick = ()=>{ CURRENT_TAB='tab2'; openModal(null,'tab2'); };
  byId('btnAddItemTab3').onclick = ()=>{ CURRENT_TAB='tab3'; openModal(null,'tab3'); };

  // Export/Share
  byId('btnExportPDFHome').onclick = ()=> exportPDFFor('home');
  byId('btnExportPDFTab2').onclick = ()=> exportPDFFor('tab2');
  byId('btnExportPDFTab3').onclick = ()=> exportPDFFor('tab3');
  byId('btnShareWAHome').onclick = ()=> shareWALink('home');
  byId('btnShareWATab2').onclick = ()=> shareWALink('tab2');
  byId('btnShareWATab3').onclick = ()=> shareWALink('tab3');

  // Modal
  byId('btnCloseModal').onclick = closeModal;
  byId('btnSaveItem').onclick  = saveItem;
  byId('btnDeleteItem').onclick= deleteItem;

  // Config — aplicar
  byId('btnApplyBrand').onclick = applyBranding;
  byId('btnApplyLinks').onclick = applyLinks;
  byId('btnApplyHtmlHome').onclick = ()=> applyHtml('home');
  byId('btnApplyHtmlTab2').onclick = ()=> applyHtml('tab2');
  byId('btnApplyHtmlTab3').onclick = ()=> applyHtml('tab3');
  byId('btnApplyGA').onclick = applyGA;

  // Backup / restore
  byId('btnBackup').onclick = doBackup;
  byId('restoreFile').addEventListener('change', e=> e.target.files[0] && doRestore(e.target.files[0]));
}

/* =========================
   BOOT
========================= */
function boot(){
  ensureDefaults();
  applyBrand();
  renderAll();
  injectGA();
  toggleAuthUI();
  bindUI();
}
window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
